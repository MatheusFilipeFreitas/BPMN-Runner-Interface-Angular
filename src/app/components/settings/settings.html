@if(loadingService.isModalLoading())
{
    <app-loading></app-loading>
}
@else
{
    <div class="secondary-nav">
        <ul class="nav-list">
            @for (item of navigationLayers; track item.id) {
                <li class="nav-topic">
                    <div (click)="selectItem(item)" class="nav-item-header">
                        <a>{{ item.title }}</a>
                    </div>
                    @if (item.childs) {
                        <ul class="nav-child-list">
                        @for (childItem of item.childs; track childItem.id) {
                            <li (click)="selectItem(childItem)" class="nav-child-item">
                                <a>{{ childItem.title }}</a>
                            </li>
                        }
                        </ul>
                    }
                </li>
            }
        </ul>
    </div>
    <div class="doc-main-content">
        <h3>{{ selectedItem().title }}</h3>

        @if (!!keys() && keys().length === 0) {
        <div class="no-content">
            <span>No API keys yet â€” create one by adding allowed origins below!</span>
        </div>
        } 
        @else {
        <p-table class="origin-table" stripedRows [value]="keys()">
            <ng-template pTemplate="header">
            <tr>
                <th>Key</th>
                <th>Created At</th>
                <th>Expires At</th>
                <th>Origins</th>
                <th>Action</th>
            </tr>
            </ng-template>

            <ng-template pTemplate="body" let-key>
            <tr>
                <td
                    (click)="copyToClipboard(key.key)"
                    class="clicable-cell"
                    title="Click to copy"
                >{{ key.key.length > 10 ? (key.key | slice:0:10) + '...' : key.key }}</td>
                <td>{{ key.createdAt?.seconds * 1000 | date:'MM/dd/yyyy' }}</td>
                <td>{{ key.expiresAt?.seconds * 1000 | date:'MM/dd/yyyy' }}</td>
                <td>
                    <button class="icon-button" type="button" (click)="showPopover($event)">
                        <app-icon class="app-icon_high-contrast">visibility</app-icon>
                    </button>

                    <p-popover #op>
                        <div class="flex flex-col gap-4">
                            <div>
                                <span class="font-medium block mb-2">Origins</span>
                                <ul class="origins-list">
                                    <li *ngFor="let origin of key.allowedOrigins" class="flex items-center gap-2 px-2 py-3 hover:bg-emphasis cursor-pointer rounded-border">
                                        <div>
                                            <span class="font-medium">{{ origin }}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </p-popover>
                </td>
                <td class="action-row">
                    <button class="icon-button" type="button" (click)="deleteKey(key.keyId)">
                        <app-icon class="app-icon_high-contrast">delete</app-icon>
                    </button>
                    <button class="icon-button" type="button" (click)="renewKey(key.keyId)">
                        <app-icon class="app-icon_high-contrast">autorenew</app-icon>
                    </button>
                </td>
            </tr>
            </ng-template>
        </p-table>
        }

        <div class="origin-input-container">
            
            <div class="line">
                @for (origin of allOrigins; track origin) {
                    <p-chip [pTooltip]="origin" tooltipPosition="top" [label]="origin.length > 10 ? (origin | slice:0:10) + '...' : origin" [removable]="true" (onRemove)="filterOrigins(origin)"></p-chip>
                }
            </div>

            <div class="form-wrapper">
                <input
                    type="text"
                    placeholder="Enter a new origin (e.g. https://api.example.com)"
                    [(ngModel)]="manualOrigin"
                    (keyup.enter)="addManualOrigin()"
                    [disabled]="allOrigins.length >= 5"
                />
                <button 
                    (click)="addManualOrigin()" 
                    class="docs-primary-btn"
                    aria-label="Add new origins"
                    [disabled]="allOrigins.length >= 5"
                >
                    <app-icon class="app-icon_high-contrast">add</app-icon>
                </button>

                <button 
                    (click)="createNewKey()" 
                    class="docs-primary-btn"
                    aria-label="Add new origins"
                    [disabled]="allOrigins.length >= 5 || allOrigins.length == 0"
                >
                    <app-icon class="app-icon_high-contrast">send</app-icon>
                </button>
            </div>
            @if (allOrigins.length >= 5) {
                <div class="limit-msg">
                    <small>You have reached the limit of 5 origins.</small>
                </div>
            }
        </div>
    </div>
}
<p-toast class="custom-toast" position="top-center" [baseZIndex]="5000"/>